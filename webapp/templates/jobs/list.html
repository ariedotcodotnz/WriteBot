{% extends "base.html" %}

{% block title %}Jobs - WriteBot{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/jobs.css') }}">
{% endblock %}

{% block content %}
<div class="bx--grid" x-data="jobsApp" x-cloak>
  <div class="bx--row">
    <div class="bx--col-lg-16">
      <div class="section-header">
        <h1 class="section-title">Job Queue</h1>
        <p class="section-subtitle">Manage your batch processing jobs</p>
      </div>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="bx--row mb-4">
    <div class="bx--col-lg-16">
      <div class="stats-row">
        <div class="stat-card stat-card--processing">
          <div class="stat-value" x-text="stats.processing || 0"></div>
          <div class="stat-label">Processing</div>
        </div>
        <div class="stat-card stat-card--queued">
          <div class="stat-value" x-text="stats.queued || 0"></div>
          <div class="stat-label">Queued</div>
        </div>
        <div class="stat-card stat-card--pending">
          <div class="stat-value" x-text="stats.pending || 0"></div>
          <div class="stat-label">Scheduled</div>
        </div>
        <div class="stat-card stat-card--completed">
          <div class="stat-value" x-text="stats.completed || 0"></div>
          <div class="stat-label">Completed</div>
        </div>
        <div class="stat-card stat-card--failed">
          <div class="stat-value" x-text="stats.failed || 0"></div>
          <div class="stat-label">Failed</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filter Bar -->
  <div class="bx--row">
    <div class="bx--col-lg-16">
      <div class="card filter-card">
        <div class="filter-bar">
          <div class="filter-group">
            <label class="bx--label" for="statusFilter">Status</label>
            <div class="bx--select bx--select--inline">
              <select id="statusFilter" class="bx--select-input" x-model="statusFilter" @change="loadJobs()">
                <option value="">All Jobs</option>
                <option value="pending">Scheduled</option>
                <option value="queued">Queued</option>
                <option value="processing">Processing</option>
                <option value="completed">Completed</option>
                <option value="failed">Failed</option>
                <option value="cancelled">Cancelled</option>
              </select>
            </div>
          </div>
          <div class="filter-actions">
            <button class="bx--btn bx--btn--ghost bx--btn--sm" @click="loadJobs(); loadStats();" title="Refresh">
              <i data-feather="refresh-cw" class="icon-sm"></i>
              <span>Refresh</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Jobs Table -->
  <div class="bx--row">
    <div class="bx--col-lg-16">
      <div class="card"
           hx-get="/jobs/api/jobs"
           hx-trigger="every 15s"
           hx-swap="none"
           @htmx:after-request="updateJobsFromHtmx($event)">

        <div class="table-container">
          <table class="bx--data-table">
            <thead>
              <tr>
                <th>Title</th>
                <th>Status</th>
                <th>Priority</th>
                <th>Progress</th>
                <th>Submitter</th>
                <th>Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="job in jobs" :key="job.id">
                <tr :class="{ 'job-row--processing': job.status === 'processing', 'job-row--mine': job.is_owner }">
                  <td>
                    <div class="job-title">
                      <span x-text="job.title"></span>
                      <span x-show="job.is_private" class="private-badge" title="Private">
                        <i data-feather="lock" class="icon-xs"></i>
                      </span>
                    </div>
                  </td>
                  <td>
                    <span class="status-badge" :class="`status-badge--${job.status}`" x-text="formatStatus(job.status)"></span>
                  </td>
                  <td>
                    <span class="priority-badge" :class="`priority-badge--${job.priority}`" x-text="getPriorityLabel(job.priority)"></span>
                  </td>
                  <td>
                    <template x-if="job.row_count > 0">
                      <div class="progress-cell">
                        <span class="progress-text" x-text="`${job.success_count}/${job.row_count}`"></span>
                        <div class="progress-bar-mini">
                          <div class="progress-fill-mini" :style="`width: ${(job.success_count/job.row_count)*100}%`"></div>
                        </div>
                        <span x-show="job.error_count > 0" class="error-count" x-text="`${job.error_count} errors`"></span>
                      </div>
                    </template>
                    <template x-if="job.row_count === 0">
                      <span class="text-muted">-</span>
                    </template>
                  </td>
                  <td>
                    <span x-text="job.submitter || (job.is_private ? 'Private' : '-')"></span>
                  </td>
                  <td>
                    <span x-text="formatDate(job.created_at)"></span>
                  </td>
                  <td>
                    <div class="action-buttons">
                      <button class="bx--btn bx--btn--ghost bx--btn--sm"
                              @click="viewJobDetails(job.id)"
                              title="View Details">
                        <i data-feather="eye" class="icon-sm"></i>
                      </button>
                      <template x-if="job.can_download">
                        <a :href="`/jobs/api/jobs/${job.id}/download`"
                           class="bx--btn bx--btn--ghost bx--btn--sm"
                           title="Download Results">
                          <i data-feather="download" class="icon-sm"></i>
                        </a>
                      </template>
                      <template x-if="job.is_owner && (job.status === 'queued' || job.status === 'pending' || job.status === 'processing')">
                        <button class="bx--btn bx--btn--danger--ghost bx--btn--sm"
                                @click="cancelJob(job.id)"
                                title="Cancel Job">
                          <i data-feather="x" class="icon-sm"></i>
                        </button>
                      </template>
                      <template x-if="job.is_owner && (job.status === 'completed' || job.status === 'failed' || job.status === 'cancelled')">
                        <button class="bx--btn bx--btn--danger--ghost bx--btn--sm"
                                @click="deleteJob(job.id)"
                                title="Delete Job">
                          <i data-feather="trash-2" class="icon-sm"></i>
                        </button>
                      </template>
                    </div>
                  </td>
                </tr>
              </template>
              <tr x-show="jobs.length === 0 && !loading">
                <td colspan="7" class="text-center text-muted py-4">
                  <i data-feather="inbox" class="icon-lg mb-2"></i>
                  <p>No jobs found</p>
                </td>
              </tr>
              <tr x-show="loading">
                <td colspan="7" class="text-center py-4">
                  <div class="loading-spinner"></div>
                  <p>Loading jobs...</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="pagination" x-show="pagination.pages > 1">
          <button class="bx--btn bx--btn--ghost bx--btn--sm"
                  :disabled="pagination.page <= 1"
                  @click="loadJobs(pagination.page - 1)">
            <i data-feather="chevron-left" class="icon-sm"></i>
            Previous
          </button>
          <span class="pagination-info" x-text="`Page ${pagination.page} of ${pagination.pages}`"></span>
          <button class="bx--btn bx--btn--ghost bx--btn--sm"
                  :disabled="pagination.page >= pagination.pages"
                  @click="loadJobs(pagination.page + 1)">
            Next
            <i data-feather="chevron-right" class="icon-sm"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Job Details Modal -->
  <div class="modal-overlay"
       :class="{ 'active': jobDetailsModalOpen }"
       @click.self="jobDetailsModalOpen = false"
       x-show="jobDetailsModalOpen"
       x-transition:enter="transition ease-out duration-200"
       x-transition:enter-start="opacity-0"
       x-transition:enter-end="opacity-100"
       x-transition:leave="transition ease-in duration-150"
       x-transition:leave-start="opacity-100"
       x-transition:leave-end="opacity-0">
    <div class="modal-content modal-content--lg">
      <div class="modal-header">
        <h3 class="modal-title" x-text="selectedJob?.title || 'Job Details'"></h3>
        <button class="modal-close" @click="jobDetailsModalOpen = false">
          <i data-feather="x"></i>
        </button>
      </div>
      <div class="modal-body" x-show="selectedJob">
        <div class="job-details-grid">
          <div class="detail-row">
            <span class="detail-label">Status</span>
            <span class="status-badge" :class="`status-badge--${selectedJob?.status}`" x-text="formatStatus(selectedJob?.status)"></span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Priority</span>
            <span class="priority-badge" :class="`priority-badge--${selectedJob?.priority}`" x-text="getPriorityLabel(selectedJob?.priority)"></span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Created</span>
            <span x-text="formatDateTime(selectedJob?.created_at)"></span>
          </div>
          <div class="detail-row" x-show="selectedJob?.scheduled_at">
            <span class="detail-label">Scheduled For</span>
            <span x-text="formatDateTime(selectedJob?.scheduled_at)"></span>
          </div>
          <div class="detail-row" x-show="selectedJob?.started_at">
            <span class="detail-label">Started</span>
            <span x-text="formatDateTime(selectedJob?.started_at)"></span>
          </div>
          <div class="detail-row" x-show="selectedJob?.completed_at">
            <span class="detail-label">Completed</span>
            <span x-text="formatDateTime(selectedJob?.completed_at)"></span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Progress</span>
            <span x-text="`${selectedJob?.success_count || 0} success, ${selectedJob?.error_count || 0} errors of ${selectedJob?.row_count || 0} total`"></span>
          </div>
          <div class="detail-row" x-show="selectedJob?.submitter">
            <span class="detail-label">Submitted By</span>
            <span x-text="selectedJob?.submitter"></span>
          </div>
          <div class="detail-row detail-row--full" x-show="selectedJob?.error_message">
            <span class="detail-label">Error</span>
            <div class="error-box">
              <span x-text="selectedJob?.error_message"></span>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <template x-if="selectedJob?.can_download">
          <a :href="`/jobs/api/jobs/${selectedJob?.id}/download`" class="bx--btn bx--btn--primary">
            <i data-feather="download" class="icon-sm"></i>
            Download Results
          </a>
        </template>
        <button class="bx--btn bx--btn--secondary" @click="jobDetailsModalOpen = false">Close</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('alpine:init', () => {
  Alpine.data('jobsApp', () => ({
    jobs: [],
    stats: {},
    pagination: { page: 1, per_page: 20, total: 0, pages: 0 },
    statusFilter: '',
    loading: true,
    jobDetailsModalOpen: false,
    selectedJob: null,

    async init() {
      await Promise.all([this.loadJobs(), this.loadStats()]);
      this.$nextTick(() => {
        if (typeof feather !== 'undefined') feather.replace();
      });
    },

    async loadJobs(page = 1) {
      this.loading = true;
      const params = new URLSearchParams({ page, per_page: 20 });
      if (this.statusFilter) params.append('status', this.statusFilter);

      try {
        const res = await fetch(`/jobs/api/jobs?${params}`);
        const data = await res.json();

        this.jobs = data.jobs || [];
        this.pagination = data.pagination || this.pagination;
      } catch (error) {
        console.error('Failed to load jobs:', error);
        if (typeof toastError !== 'undefined') toastError('Failed to load jobs');
      } finally {
        this.loading = false;
        this.$nextTick(() => {
          if (typeof feather !== 'undefined') feather.replace();
        });
      }
    },

    async loadStats() {
      try {
        const res = await fetch('/jobs/api/jobs/stats');
        this.stats = await res.json();
      } catch (error) {
        console.error('Failed to load stats:', error);
      }
    },

    updateJobsFromHtmx(event) {
      if (event.detail.successful) {
        try {
          const data = JSON.parse(event.detail.xhr.responseText);
          this.jobs = data.jobs || [];
          this.pagination = data.pagination || this.pagination;
          this.loadStats();
          this.$nextTick(() => {
            if (typeof feather !== 'undefined') feather.replace();
          });
        } catch (e) {
          console.error('Failed to parse HTMX response:', e);
        }
      }
    },

    formatStatus(status) {
      const labels = {
        'pending': 'Scheduled',
        'queued': 'Queued',
        'processing': 'Processing',
        'completed': 'Completed',
        'failed': 'Failed',
        'cancelled': 'Cancelled'
      };
      return labels[status] || status;
    },

    getPriorityLabel(priority) {
      const labels = { 1: 'Low', 2: 'Low', 3: 'Normal', 4: 'High', 5: 'Critical' };
      return labels[priority] || 'Normal';
    },

    formatDate(isoString) {
      if (!isoString) return '-';
      const date = new Date(isoString);
      return date.toLocaleDateString();
    },

    formatDateTime(isoString) {
      if (!isoString) return '-';
      const date = new Date(isoString);
      return date.toLocaleString();
    },

    async viewJobDetails(jobId) {
      try {
        const res = await fetch(`/jobs/api/jobs/${jobId}`);
        const data = await res.json();
        this.selectedJob = data.job;
        this.jobDetailsModalOpen = true;
        this.$nextTick(() => {
          if (typeof feather !== 'undefined') feather.replace();
        });
      } catch (error) {
        console.error('Failed to load job details:', error);
        if (typeof toastError !== 'undefined') toastError('Failed to load job details');
      }
    },

    async cancelJob(jobId) {
      if (!confirm('Are you sure you want to cancel this job?')) return;

      try {
        const res = await fetch(`/jobs/api/jobs/${jobId}`, { method: 'DELETE' });
        const data = await res.json();

        if (res.ok) {
          if (typeof toastSuccess !== 'undefined') toastSuccess('Job cancelled');
          await Promise.all([this.loadJobs(this.pagination.page), this.loadStats()]);
        } else {
          if (typeof toastError !== 'undefined') toastError(data.error || 'Failed to cancel job');
        }
      } catch (error) {
        console.error('Failed to cancel job:', error);
        if (typeof toastError !== 'undefined') toastError('Failed to cancel job');
      }
    },

    async deleteJob(jobId) {
      if (!confirm('Are you sure you want to delete this job? This cannot be undone.')) return;

      try {
        const res = await fetch(`/jobs/api/jobs/${jobId}`, { method: 'DELETE' });
        const data = await res.json();

        if (res.ok) {
          if (typeof toastSuccess !== 'undefined') toastSuccess('Job deleted');
          await Promise.all([this.loadJobs(this.pagination.page), this.loadStats()]);
        } else {
          if (typeof toastError !== 'undefined') toastError(data.error || 'Failed to delete job');
        }
      } catch (error) {
        console.error('Failed to delete job:', error);
        if (typeof toastError !== 'undefined') toastError('Failed to delete job');
      }
    }
  }));
});

// Initialize feather icons on page load
document.addEventListener('DOMContentLoaded', () => {
  if (typeof feather !== 'undefined') feather.replace();
});
</script>
{% endblock %}
