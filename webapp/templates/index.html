{% extends "base.html" %}

{% block content %}
    <div class="bx--grid">
      <!-- Main Configuration Panel -->
      <div class="bx--row">
        <div class="bx--col-lg-16">
          <div class="section-header">
            <h1 class="section-title">
              Handwriting Synthesis
            </h1>
          </div>
        </div>
      </div>

      <div class="bx--row">
        <!-- Left Column: Input & Configuration -->
        <div class="bx--col-lg-5 bx--col-md-8">
          <!-- Text Input Card -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Text Input</h3>
            </div>
            <div class="bx--form">
              <div class="bx--form-item">
                <label for="text" class="bx--label">Content</label>
                <div class="bx--text-area__wrapper">
                  <textarea id="text" class="bx--text-area" rows="6"
                    placeholder="Enter your text here. Each line will become a new paragraph.
Use \\ on its own line to insert blank space."></textarea>
                </div>
                <div class="bx--form__helper-text text-small mt-1">
                  Text will automatically wrap based on page settings.
                </div>
              </div>
            </div>
          </div>

          <!-- Style Configuration Card -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Style Configuration</h3>
            </div>
            <div class="bx--form">
              <div class="form-grid">
                <div class="form-group">
                  <label for="styleSelect" class="bx--label label-with-tooltip">
                    Base Style
                    <span class="tooltip-icon">
                      <span class="tooltip-text">Choose a handwriting style. Each style represents a different handwriting character.</span>
                    </span>
                  </label>
                  <div id="styleSelectWrapper" class="style-dropdown-wrapper">
                    <div class="bx--select style-select-trigger">
                      <select id="styleSelect" class="bx--select-input">
                        <option value="">Loading styles...</option>
                      </select>
                      <i data-feather="chevron-down" class="bx--select__arrow"></i>
                    </div>
                    <div id="styleDropdown" class="style-dropdown-custom"></div>
                  </div>
                </div>
                <div class="form-group">
                  <label for="legibility" class="bx--label label-with-tooltip">
                    Legibility
                    <span class="tooltip-icon">
                      <span class="tooltip-text">Controls how clear and readable the handwriting is. Higher = more legible but less natural.</span>
                    </span>
                  </label>
                  <div class="bx--select">
                    <select id="legibility" class="bx--select-input">
                      <option value="natural">Natural</option>
                      <option value="normal" selected>Normal</option>
                      <option value="high">High</option>
                    </select>
                    <i data-feather="chevron-down" class="bx--select__arrow"></i>
                  </div>
                </div>
                <div class="form-group">
                  <label for="characterOverrideCollection" class="bx--label label-with-tooltip">
                    Character Overrides
                    <span class="tooltip-icon">
                      <span class="tooltip-text">Apply custom handwritten characters from a collection instead of AI-generated ones.</span>
                    </span>
                  </label>
                  <div class="bx--select">
                    <select id="characterOverrideCollection" class="bx--select-input">
                      <option value="">None (use AI)</option>
                    </select>
                    <i data-feather="chevron-down" class="bx--select__arrow"></i>
                  </div>
                </div>
              </div>

              <!-- Advanced Style Options -->
              <details class="mt-2">
                <summary style="cursor: pointer; font-weight: 500; color: var(--interactive-01);">
                  Advanced Style Options
                </summary>
                <div class="form-grid mt-2">
                  <div class="form-group">
                    <label for="biases" class="bx--label label-with-tooltip">
                      Biases
                      <span class="tooltip-icon">
                        <span class="tooltip-text">Controls writing style variance. Lower values (0.5-0.7) = more random/natural, higher (0.8-1.0) = more consistent. Separate values with | for each line.</span>
                      </span>
                    </label>
                    <input id="biases" class="bx--text-input" type="text" placeholder="0.75|0.75|0.6" />
                  </div>
                  <div class="form-group">
                    <label for="styles" class="bx--label label-with-tooltip">
                      Per-line Styles
                      <span class="tooltip-icon">
                        <span class="tooltip-text">Use different handwriting styles for each line. Separate style numbers with | (e.g., 9|9|12).</span>
                      </span>
                    </label>
                    <input id="styles" class="bx--text-input" type="text" placeholder="9|9|12" />
                  </div>
                  <div class="form-group">
                    <label for="strokeColors" class="bx--label label-with-tooltip">
                      Stroke Colors
                      <span class="tooltip-icon">
                        <span class="tooltip-text">Set ink color for each line. Use color names (black, blue) or hex codes (#333). Separate with |.</span>
                      </span>
                    </label>
                    <input id="strokeColors" class="bx--text-input" type="text" placeholder="black|#333|red" />
                  </div>
                  <div class="form-group">
                    <label for="strokeWidths" class="bx--label label-with-tooltip">
                      Stroke Widths
                      <span class="tooltip-icon">
                        <span class="tooltip-text">Controls pen thickness for each line. Default is 1. Separate with | for different widths per line.</span>
                      </span>
                    </label>
                    <input id="strokeWidths" class="bx--text-input" type="text" placeholder="1|1|1" />
                  </div>
                  <div class="form-group">
                    <label for="xStretch" class="bx--label label-with-tooltip">
                      Horizontal Stretch
                      <span class="tooltip-icon">
                        <span class="tooltip-text">Stretches handwriting horizontally. 1.0 = normal, >1.0 = wider, <1.0 = narrower.</span>
                      </span>
                    </label>
                    <input id="xStretch" class="bx--text-input" type="number" step="0.05" placeholder="1.0" />
                  </div>
                  <div class="form-group">
                    <label for="denoise" class="bx--label label-with-tooltip">
                      Denoise
                      <span class="tooltip-icon">
                        <span class="tooltip-text">Smooths out handwriting strokes for cleaner lines. Recommended to keep enabled.</span>
                      </span>
                    </label>
                    <div class="bx--select">
                      <select id="denoise" class="bx--select-input">
                        <option value="true" selected>Enabled</option>
                        <option value="false">Disabled</option>
                      </select>
                      <i data-feather="chevron-down" class="bx--select__arrow"></i>
                    </div>
                  </div>
                </div>
              </details>
            </div>
          </div>

          <!-- Page Settings Card -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Page Settings</h3>
            </div>
            <div class="bx--form">
              <div class="form-grid">
                <div class="form-group">
                  <label for="templatePreset" class="bx--label label-with-tooltip">
                    Template Preset
                    <span class="tooltip-icon">
                      <span class="tooltip-text">Select a predefined template with page size and layout settings, or choose "None" for manual configuration.</span>
                    </span>
                  </label>
                  <div class="bx--select">
                    <select id="templatePreset" class="bx--select-input">
                      <option value="">None (Manual Settings)</option>
                    </select>
                    <i data-feather="chevron-down" class="bx--select__arrow"></i>
                  </div>
                </div>
                <div class="form-group">
                  <label for="pageSize" class="bx--label label-with-tooltip">
                    Page Size
                    <span class="tooltip-icon">
                      <span class="tooltip-text">Select a page size preset (A4, Letter, etc.) or choose 'Custom' to specify your own dimensions.</span>
                    </span>
                  </label>
                  <div class="bx--select">
                    <select id="pageSize" class="bx--select-input">
                      <option value="">Loading...</option>
                    </select>
                    <i data-feather="chevron-down" class="bx--select__arrow"></i>
                  </div>
                </div>
                <div class="form-group">
                  <label for="orientation" class="bx--label label-with-tooltip">
                    Orientation
                    <span class="tooltip-icon">
                      <span class="tooltip-text">Portrait = vertical (taller than wide). Landscape = horizontal (wider than tall).</span>
                    </span>
                  </label>
                  <div class="bx--select">
                    <select id="orientation" class="bx--select-input">
                      <option value="portrait">Portrait</option>
                      <option value="landscape">Landscape</option>
                    </select>
                    <i data-feather="chevron-down" class="bx--select__arrow"></i>
                  </div>
                </div>
                <div class="form-group">
                  <label for="units" class="bx--label label-with-tooltip">
                    Units
                    <span class="tooltip-icon">
                      <span class="tooltip-text">Measurement units for margins and dimensions. Use mm (millimeters) for print output, px (pixels) for screen.</span>
                    </span>
                  </label>
                  <div class="bx--select">
                    <select id="units" class="bx--select-input">
                      <option value="mm">Millimeters</option>
                      <option value="px">Pixels</option>
                    </select>
                    <i data-feather="chevron-down" class="bx--select__arrow"></i>
                  </div>
                </div>
                <div class="form-group">
                  <label for="align" class="bx--label label-with-tooltip">
                    Text Alignment
                    <span class="tooltip-icon">
                      <span class="tooltip-text">Horizontal text alignment on the page. Left is most natural for handwriting.</span>
                    </span>
                  </label>
                  <div class="bx--select">
                    <select id="align" class="bx--select-input">
                      <option value="left">Left</option>
                      <option value="center">Center</option>
                      <option value="right">Right</option>
                    </select>
                    <i data-feather="chevron-down" class="bx--select__arrow"></i>
                  </div>
                </div>
              </div>

              <!-- Custom Size Fields -->
              <div id="customSizeFields" style="display: none;">
                <div class="form-grid mt-2">
                  <div class="form-group">
                    <label for="pageWidth" class="bx--label label-with-tooltip">
                      Width
                      <span class="tooltip-icon">
                        <span class="tooltip-text">Custom page width in the selected units. Example: 210 for A4 width in mm.</span>
                      </span>
                    </label>
                    <input id="pageWidth" class="bx--text-input" type="number" step="any" placeholder="210" />
                  </div>
                  <div class="form-group">
                    <label for="pageHeight" class="bx--label label-with-tooltip">
                      Height
                      <span class="tooltip-icon">
                        <span class="tooltip-text">Custom page height in the selected units. Example: 297 for A4 height in mm.</span>
                      </span>
                    </label>
                    <input id="pageHeight" class="bx--text-input" type="number" step="any" placeholder="297" />
                  </div>
                </div>
              </div>

              <!-- Layout Settings -->
              <div class="form-grid mt-3">
                <div class="form-group">
                  <label class="bx--label label-with-tooltip">
                    Margins
                    <span class="tooltip-icon">
                      <span class="tooltip-text">Set page margins (Top, Right, Bottom, Left) in the selected units.</span>
                    </span>
                  </label>
                  <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem;">
                    <input id="marginTop" class="bx--text-input" type="number" placeholder="Top" title="Top margin" />
                    <input id="marginRight" class="bx--text-input" type="number" placeholder="Right" title="Right margin" />
                    <input id="marginBottom" class="bx--text-input" type="number" placeholder="Bottom" title="Bottom margin" />
                    <input id="marginLeft" class="bx--text-input" type="number" placeholder="Left" title="Left margin" />
                  </div>
                </div>
                <div class="form-group">
                  <label for="lineHeight" class="bx--label label-with-tooltip">
                    Line Height
                    <span class="tooltip-icon">
                      <span class="tooltip-text">Vertical spacing between lines of text. Leave empty for automatic spacing.</span>
                    </span>
                  </label>
                  <input id="lineHeight" class="bx--text-input" type="number" placeholder="Auto" title="Spacing between regular lines" />
                </div>
                <div class="form-group">
                  <label for="emptyLineSpacing" class="bx--label label-with-tooltip">
                    Empty Line Spacing
                    <span class="tooltip-icon">
                      <span class="tooltip-text">Spacing when you use \\ to create blank lines. Leave empty for automatic.</span>
                    </span>
                  </label>
                  <input id="emptyLineSpacing" class="bx--text-input" type="number" placeholder="Auto" title="Spacing for empty/blank lines" />
                </div>
                <div class="form-group">
                  <label for="globalScale" class="bx--label label-with-tooltip">
                    Global Scale
                    <span class="tooltip-icon">
                      <span class="tooltip-text">Scales the entire output. 1.0 = normal size, >1.0 = larger, <1.0 = smaller.</span>
                    </span>
                  </label>
                  <input id="globalScale" class="bx--text-input" type="number" step="0.1" placeholder="1.0" />
                </div>
                <div class="form-group">
                  <label for="background" class="bx--label label-with-tooltip">
                    Background
                    <span class="tooltip-icon">
                      <span class="tooltip-text">Background color for the page. Use color names or hex codes. Use 'transparent' for no background.</span>
                    </span>
                  </label>
                  <input id="background" class="bx--text-input" type="text" placeholder="white" />
                </div>
              </div>

              <!-- Writing Size Settings -->
              <div class="form-grid mt-3">
                <div class="form-group">
                  <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input id="autoSize" type="checkbox" checked style="width: auto;" />
                    <span class="bx--label label-with-tooltip" style="margin: 0;">
                      Auto Size (fit to line height)
                      <span class="tooltip-icon">
                        <span class="tooltip-text">Automatically adjusts text size to fit the line height. Recommended for consistent results.</span>
                      </span>
                    </span>
                  </label>
                </div>
                <div class="form-group">
                  <label for="manualSizeScale" class="bx--label label-with-tooltip">
                    Manual Size Scale
                    <span class="tooltip-icon">
                      <span class="tooltip-text">Manual text size when Auto Size is disabled. 1.0 = normal, 2.0 = double, 0.5 = half.</span>
                    </span>
                  </label>
                  <input id="manualSizeScale" class="bx--text-input" type="number" step="0.1" placeholder="1.0" disabled />
                </div>
              </div>

              <!-- Advanced Layout Options -->
              <details class="mt-2">
                <summary style="cursor: pointer; font-weight: 500; color: var(--interactive-01);">
                  Text Wrapping Options
                </summary>
                <div class="form-grid mt-2">
                  <div class="form-group">
                    <label for="wrapCharPx" class="bx--label label-with-tooltip">
                      Character Width (px)
                      <span class="tooltip-icon">
                        <span class="tooltip-text">Estimated character width in pixels for wrapping calculations. Leave empty for automatic.</span>
                      </span>
                    </label>
                    <input id="wrapCharPx" class="bx--text-input" type="number" step="0.5" placeholder="10.5" />
                  </div>
                  <div class="form-group">
                    <label for="wrapRatio" class="bx--label label-with-tooltip">
                      Wrap Ratio
                      <span class="tooltip-icon">
                        <span class="tooltip-text">Text wrapping ratio (0.1-0.3). Controls how text breaks across lines. Default: 0.18.</span>
                      </span>
                    </label>
                    <input id="wrapRatio" class="bx--text-input" type="number" step="0.01" placeholder="0.18" />
                  </div>
                  <div class="form-group">
                    <label for="wrapUtil" class="bx--label label-with-tooltip">
                      Utilization
                      <span class="tooltip-icon">
                        <span class="tooltip-text">Line width utilization (1.0-2.0). Higher values fill more of the available line width. Default: 1.35.</span>
                      </span>
                    </label>
                    <input id="wrapUtil" class="bx--text-input" type="number" step="0.05" placeholder="1.35" />
                  </div>
                </div>
              </details>

              <!-- Text Generation Options -->
              <details class="mt-2">
                <summary style="cursor: pointer; font-weight: 500; color: var(--interactive-01);">
                  Text Generation Options (Advanced)
                </summary>
                <div class="form-grid mt-2">
                  <div class="form-group">
                    <div class="label-with-tooltip" style="margin-bottom: 0.25rem;">
                      <label class="bx--checkbox-wrapper" style="margin: 0;">
                        <input id="useChunked" type="checkbox" class="bx--checkbox" checked />
                        <label for="useChunked" class="bx--checkbox-label">
                          <span class="bx--checkbox-label-text">Use Chunked Generation (Recommended)</span>
                        </label>
                      </label>
                      <span class="tooltip-icon">
                        <span class="tooltip-text">Generate text in small word groups for better quality. Strongly recommended for all uses.</span>
                      </span>
                    </div>
                    <small style="display: block; color: var(--text-02);">
                      Generate text in small chunks for better quality and longer lines
                    </small>
                  </div>
                  <div class="form-group">
                    <div class="label-with-tooltip" style="margin-bottom: 0.25rem;">
                      <label class="bx--checkbox-wrapper" style="margin: 0;">
                        <input id="adaptiveChunking" type="checkbox" class="bx--checkbox" checked />
                        <label for="adaptiveChunking" class="bx--checkbox-label">
                          <span class="bx--checkbox-label-text">Adaptive Chunking</span>
                        </label>
                      </label>
                      <span class="tooltip-icon">
                        <span class="tooltip-text">Intelligently varies chunk sizes based on word boundaries, punctuation, and sentence structure.</span>
                      </span>
                    </div>
                    <small style="display: block; color: var(--text-02);">
                      Intelligently adjust chunk sizes based on text content
                    </small>
                  </div>
                  <div class="form-group">
                    <label for="adaptiveStrategy" class="bx--label label-with-tooltip">
                      Adaptive Strategy
                      <span class="tooltip-icon">
                        <span class="tooltip-text">How text is split into chunks: balanced (recommended) combines strategies, word_length groups by length, sentence respects sentences, punctuation breaks at punctuation.</span>
                      </span>
                    </label>
                    <div class="bx--select">
                      <select id="adaptiveStrategy" class="bx--select-input">
                        <option value="balanced" selected>Balanced (Recommended)</option>
                        <option value="word_length">Word Length</option>
                        <option value="sentence">Sentence Boundaries</option>
                        <option value="punctuation">Punctuation Aware</option>
                        <option value="off">Fixed Size</option>
                      </select>
                      <i data-feather="chevron-down" class="bx--select__arrow"></i>
                    </div>
                    <small style="display: block; margin-top: 0.25rem; color: var(--text-02);">
                      How to split text into chunks (balanced combines multiple strategies)
                    </small>
                  </div>
                  <div class="form-group">
                    <label for="wordsPerChunk" class="bx--label label-with-tooltip">
                      Words Per Chunk
                      <span class="tooltip-icon">
                        <span class="tooltip-text">Target number of words per chunk (1-8). Fewer words = more variation, more words = smoother flow. Default: 3.</span>
                      </span>
                    </label>
                    <input id="wordsPerChunk" class="bx--text-input" type="number" step="1" min="1" max="8" placeholder="3" />
                    <small style="display: block; margin-top: 0.25rem; color: var(--text-02);">
                      Target words per chunk (adaptively adjusted)
                    </small>
                  </div>
                  <div class="form-group">
                    <label for="chunkSpacing" class="bx--label label-with-tooltip">
                      Chunk Spacing
                      <span class="tooltip-icon">
                        <span class="tooltip-text">Horizontal space between word chunks in pixels. Larger values create more visible gaps between word groups. Default: 8.0.</span>
                      </span>
                    </label>
                    <input id="chunkSpacing" class="bx--text-input" type="number" step="0.5" min="0" placeholder="8.0" />
                    <small style="display: block; margin-top: 0.25rem; color: var(--text-02);">
                      Horizontal space between chunks (default: 8.0)
                    </small>
                  </div>
                  <div class="form-group">
                    <label for="maxLineWidth" class="bx--label label-with-tooltip">
                      Max Line Width
                      <span class="tooltip-icon">
                        <span class="tooltip-text">Maximum width of a line in coordinate units before wrapping to the next line. Default: 800.</span>
                      </span>
                    </label>
                    <input id="maxLineWidth" class="bx--text-input" type="number" step="10" min="300" placeholder="800" />
                    <small style="display: block; margin-top: 0.25rem; color: var(--text-02);">
                      Maximum line width in coordinate units (default: 800)
                    </small>
                  </div>
                </div>
              </details>

              <!-- Save as Preset Button (Admin Only) -->
              {% if current_user.is_authenticated and current_user.role == 'admin' %}
              <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--ui-03);">
                <button type="button" class="bx--btn bx--btn--tertiary bx--btn--sm" onclick="openSavePresetModal()">
                  <i data-feather="save" style="margin-right: 0.5rem; width: 14px; height: 14px;"></i>
                  Save as Preset
                </button>
                <small style="display: block; margin-top: 0.5rem; color: var(--text-02);">
                  Save current settings as a template preset (Admin only)
                </small>
              </div>
              {% endif %}
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="actions-bar actions-bar-sticky">
            <div class="actions-primary">
              <button class="bx--btn bx--btn--primary" onclick="generate()">
                <i data-feather="zap" style="margin-right: 0.5rem; width: 16px; height: 16px;"></i>
                Generate Handwriting
              </button>
              <button class="bx--btn bx--btn--secondary" onclick="downloadSVG()">
                <i data-feather="download" style="margin-right: 0.5rem; width: 16px; height: 16px;"></i>
                Download SVG
              </button>
              <button class="bx--btn bx--btn--secondary" onclick="downloadPDF()">
                <i data-feather="file-text" style="margin-right: 0.5rem; width: 16px; height: 16px;"></i>
                Download PDF
              </button>
            </div>
          </div>
        </div>

        <!-- Right Column: Preview & Output -->
        <div class="bx--col-lg-7 bx--col-md-7">
          <!-- Preview Card with Rulers -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Preview</h3>
              <div style="display: flex; align-items: center; gap: 1rem;">
                <label for="zoom" class="text-small text-muted">Zoom:</label>
                <input id="zoom" type="range" min="25" max="200" value="100" style="width: 120px;" />
                <span id="zoomVal" class="text-small">100%</span>
              </div>
            </div>
            <div class="preview-container-with-ruler" id="previewContainerRuler">
              <div class="preview-container">
                <div id="preview">
                  <div class="preview-empty">Generated handwriting will appear here</div>
                </div>
              </div>
            </div>
          </div>

          <!-- SVG Source Output -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">SVG Source Code</h3>
              <button class="bx--btn bx--btn--ghost bx--btn--sm" onclick="copySvg()">
                <i data-feather="copy" style="margin-right: 0.5rem; width: 16px; height: 16px;"></i>
                Copy to Clipboard
              </button>
            </div>
            <div class="code-container">
              <div class="code-content">
                <pre id="output"><code>// SVG output will appear here after generation</code></pre>
              </div>
            </div>
            <div class="text-small text-muted mt-2" style="padding: 0 1rem;">
              <strong>Metadata:</strong> <span id="metaInfo">Generate handwriting to view metadata</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Batch Processing Section -->
      <div class="bx--row mt-3">
        <div class="bx--col-lg-20">
          <div class="section-header">
            <h2 class="section-title">Batch Processing</h2>
          </div>
        </div>
      </div>

      <div class="bx--row">
        <div class="bx--col-lg-10 bx--col-md-10">
          <div class="card">
            <!-- Upload Area -->
            <div id="csvDrop" class="dropzone" onclick="document.getElementById('csv').click()" title="Upload a CSV or XLSX file with your batch data. Use the template buttons below to get started.">
              <div class="dropzone-icon">
                <i data-feather="file-text" style="width: 48px; height: 48px; stroke-width: 1.5;"></i>
              </div>
              <div class="dropzone-text">Drop CSV or XLSX file here or click to browse</div>
              <div class="dropzone-subtext">Maximum file size: 10MB. Current form settings will be used as defaults for missing columns.</div>
              <div id="csvInfo" style="display: none;"></div>
            </div>
            <input id="csv" type="file" accept=".csv,.xlsx" style="display: none;" />

            <div class="actions-bar">
              <button class="bx--btn bx--btn--primary" onclick="batchGenerateStream()">
                <i data-feather="layers" style="margin-right: 0.5rem; width: 16px; height: 16px;"></i>
                Start Batch Processing
              </button>
              <a href="/api/template-xlsx" class="bx--btn bx--btn--secondary" title="Download an XLSX template with all columns, dropdowns, and tooltips">
                <i data-feather="download" style="margin-right: 0.5rem; width: 16px; height: 16px;"></i>
                Download XLSX Template
              </a>
              <a href="/api/template-csv" class="bx--btn bx--btn--tertiary" title="Download a basic CSV template with column headers">
                <i data-feather="file" style="margin-right: 0.5rem; width: 16px; height: 16px;"></i>
                CSV Template
              </a>
              <a href="/api/sample-xlsx" class="bx--btn bx--btn--tertiary" title="Download an XLSX file with example data to learn from">
                <i data-feather="book-open" style="margin-right: 0.5rem; width: 16px; height: 16px;"></i>
                Sample XLSX
              </a>
              <div class="actions-secondary">
                <label style="display: flex; align-items: center; gap: 0.5rem; margin-right: 1rem;" class="label-with-tooltip">
                  <input id="autoStartBatch" type="checkbox" style="width: auto;" />
                  <span class="text-small text-muted">Auto-start on upload</span>
                  <span class="tooltip-icon">
                    <span class="tooltip-text">Automatically start batch processing when a file is dropped or selected.</span>
                  </span>
                </label>
                <label for="liveLimit" class="text-small text-muted label-with-tooltip" style="display: flex; align-items: center; gap: 0.25rem;">
                  Preview limit:
                  <span class="tooltip-icon">
                    <span class="tooltip-text">Maximum number of live previews to show during processing. Higher values use more memory.</span>
                  </span>
                </label>
                <input id="liveLimit" class="bx--text-input" type="number" min="1" max="50" value="12" style="width: 80px;" title="Maximum number of live previews to display" />
              </div>
            </div>

            <!-- Batch Status -->
            <div class="batch-container" id="batchContainer" style="display: none;">
              <div class="batch-header">
                <h4>Processing Status</h4>
                <button class="bx--btn bx--btn--ghost bx--btn--sm" onclick="clearBatchUI()">
                  <i data-feather="trash-2" style="margin-right: 0.25rem; width: 16px; height: 16px;"></i>
                  Clear
                </button>
              </div>

              <!-- Progress Bar -->
              <div class="progress-bar">
                <div id="progressFill" class="progress-fill" style="width: 0%"></div>
              </div>

              <!-- Statistics -->
              <div class="batch-stats">
                <div class="stat-card">
                  <span id="batchProg" class="stat-value">0</span>
                  <span class="stat-label">Processed</span>
                </div>
                <div class="stat-card">
                  <span id="batchTotal" class="stat-value">0</span>
                  <span class="stat-label">Total</span>
                </div>
                <div class="stat-card">
                  <span id="batchOk" class="stat-value">0</span>
                  <span class="stat-label">Success</span>
                </div>
                <div class="stat-card">
                  <span id="batchErr" class="stat-value">0</span>
                  <span class="stat-label">Errors</span>
                </div>
              </div>

              <!-- Live Previews and Log -->
              <div class="batch-previews">
                <div class="preview-section">
                  <div class="preview-section-header">Live Previews (click to enlarge)</div>
                  <div id="batchLiveGrid" class="live-preview-grid"></div>
                </div>
                <div class="preview-section">
                  <div class="preview-section-header">Processing Log</div>
                  <div class="code-container" style="color: white; max-height: 400px; overflow-y: auto;">
                    <pre id="batchLog" style="margin: 0; padding: 1rem; font-size: 0.85rem; line-height: 1.4;"><code>Ready to process batch...</code></pre>
                  </div>
                </div>
              </div>

              <!-- Download Button -->
              <div class="actions-bar mt-2">
                <a id="batchDownload" class="bx--btn bx--btn--primary" style="display: none;">
                  <i data-feather="download" style="margin-right: 0.5rem; width: 16px; height: 16px;"></i>
                  Download Results
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Save Preset Modal -->
    <div id="savePresetModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
      <div style="background: var(--ui-01, #fff); border-radius: 4px; max-width: 500px; width: 90%; padding: 2rem; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
        <h3 style="margin: 0 0 1rem 0; font-size: 1.25rem;">Save as Template Preset</h3>
        <div class="bx--form">
          <div class="bx--form-item" style="margin-bottom: 1rem;">
            <label for="presetName" class="bx--label">Template Name *</label>
            <input type="text" id="presetName" class="bx--text-input" placeholder="e.g., Standard Letter" required />
          </div>
          <div class="bx--form-item" style="margin-bottom: 1.5rem;">
            <label for="presetDescription" class="bx--label">Description (Optional)</label>
            <textarea id="presetDescription" class="bx--text-area" rows="3" placeholder="Describe this template's use case..."></textarea>
          </div>
          <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
            <button type="button" class="bx--btn bx--btn--secondary" onclick="closeSavePresetModal()">Cancel</button>
            <button type="button" class="bx--btn bx--btn--primary" onclick="savePreset()">Save Preset</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Batch Preview Modal -->
    <div id="batchPreviewModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); z-index: 9999; align-items: center; justify-content: center;" onclick="closeBatchPreview()">
      <div style="background: var(--ui-01, #fff); border-radius: 4px; max-width: 90%; max-height: 90%; padding: 2rem; box-shadow: 0 4px 12px rgba(0,0,0,0.3); overflow: auto;" onclick="event.stopPropagation()">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h3 id="batchPreviewTitle" style="margin: 0; font-size: 1.25rem;">Preview</h3>
          <button class="bx--btn bx--btn--ghost bx--btn--sm" onclick="closeBatchPreview()">
            <i data-feather="x" style="width: 16px; height: 16px;"></i>
          </button>
        </div>
        <div id="batchPreviewContent" style="display: flex; justify-content: center; align-items: center; min-height: 200px;"></div>
      </div>
    </div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    {% assets "js_generator" %}
        <script src="{{ ASSET_URL }}"></script>
    {% endassets %}
<!-- PDF Generation Libraries -->
<script src="{{ url_for('static', filename='js/libraries/jspdf.umd.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/libraries/svg2pdf/svg2pdf.umd.min.js') }}"></script>
<script>
  // Initialize Feather icons and SVG ruler after page load
  document.addEventListener('DOMContentLoaded', () => {
    feather.replace();

    // Initialize SVG ruler system
    if (typeof initSVGRuler === 'function') {
      initSVGRuler();
    }
  });
</script>
{% endblock %}