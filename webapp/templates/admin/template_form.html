{% extends "admin/base.html" %}

{% set active_nav = 'templates' %}

{% block title %}{{ 'Edit' if action == 'edit' else 'Create' }} Template - Admin - WriteBot{% endblock %}

{% block admin_title %}{{ 'Edit Template' if action == 'edit' else 'Create New Template' }}{% endblock %}

{% block admin_header_actions %}
<a href="{{ url_for('admin.templates') }}" class="btn btn-secondary">Back to Templates</a>
{% endblock %}

{% block admin_content %}
<div class="admin-section">
    <form method="POST" data-validate>
        <div class="form-group">
            <label for="name">Template Name *</label>
            <input type="text" id="name" name="name" required
                   value="{{ template.name if template else '' }}">
            <div class="help-text">Descriptive name for this template (e.g., "Standard Letter", "A4 with Margins").</div>
        </div>

        <div class="form-group">
            <label for="description">Description</label>
            <textarea id="description" name="description" rows="3">{{ template.description if template else '' }}</textarea>
            <div class="help-text">Optional description of this template's use case.</div>
        </div>

        <div class="form-group">
            <label for="page_size_preset_id">Page Size *</label>
            <select id="page_size_preset_id" name="page_size_preset_id" required>
                <option value="">-- Select a page size --</option>
                {% for page_size in page_sizes %}
                <option value="{{ page_size.id }}"
                        {{ 'selected' if template and template.page_size_preset_id == page_size.id else '' }}>
                    {{ page_size.name }} ({{ page_size.width }} x {{ page_size.height }} {{ page_size.unit }})
                </option>
                {% endfor %}
            </select>
            <div class="help-text">Select the page size for this template.</div>
        </div>

        <div class="form-group">
            <label for="orientation">Orientation *</label>
            <select id="orientation" name="orientation" required>
                <option value="portrait" {{ 'selected' if template and template.orientation == 'portrait' else 'selected' }}>Portrait</option>
                <option value="landscape" {{ 'selected' if template and template.orientation == 'landscape' else '' }}>Landscape</option>
            </select>
        </div>

        <div class="form-section-title">Margins</div>

        <div class="form-row">
            <div class="form-group">
                <label for="margin_top">Top</label>
                <input type="number" id="margin_top" name="margin_top" step="0.1" min="0"
                       value="{{ template.margin_top if template else '10.0' }}">
            </div>

            <div class="form-group">
                <label for="margin_right">Right</label>
                <input type="number" id="margin_right" name="margin_right" step="0.1" min="0"
                       value="{{ template.margin_right if template else '10.0' }}">
            </div>

            <div class="form-group">
                <label for="margin_bottom">Bottom</label>
                <input type="number" id="margin_bottom" name="margin_bottom" step="0.1" min="0"
                       value="{{ template.margin_bottom if template else '10.0' }}">
            </div>

            <div class="form-group">
                <label for="margin_left">Left</label>
                <input type="number" id="margin_left" name="margin_left" step="0.1" min="0"
                       value="{{ template.margin_left if template else '10.0' }}">
            </div>
        </div>

        <div class="form-group">
            <label for="margin_unit">Margin Unit</label>
            <select id="margin_unit" name="margin_unit">
                <option value="mm" {{ 'selected' if template and template.margin_unit == 'mm' else 'selected' }}>Millimeters (mm)</option>
                <option value="px" {{ 'selected' if template and template.margin_unit == 'px' else '' }}>Pixels (px)</option>
            </select>
        </div>

        <div class="form-section-title">Line Settings (Optional)</div>

        <div class="form-row">
            <div class="form-group">
                <label for="line_height">Line Height</label>
                <input type="number" id="line_height" name="line_height" step="0.1" min="0"
                       value="{{ template.line_height if template else '' }}">
                <div class="help-text">Leave blank for auto calculation.</div>
            </div>

            <div class="form-group">
                <label for="line_height_unit">Line Height Unit</label>
                <select id="line_height_unit" name="line_height_unit">
                    <option value="mm" {{ 'selected' if template and template.line_height_unit == 'mm' else 'selected' }}>Millimeters (mm)</option>
                    <option value="px" {{ 'selected' if template and template.line_height_unit == 'px' else '' }}>Pixels (px)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="empty_line_spacing">Empty Line Spacing</label>
                <input type="number" id="empty_line_spacing" name="empty_line_spacing" step="0.1" min="0"
                       value="{{ template.empty_line_spacing if template and template.empty_line_spacing else '' }}">
                <div class="help-text">Spacing for empty lines (optional).</div>
            </div>
        </div>

        <div class="form-section-title">Text Alignment & Scaling (Optional)</div>

        <div class="form-row">
            <div class="form-group">
                <label for="text_alignment">Text Alignment</label>
                <select id="text_alignment" name="text_alignment">
                    <option value="left" {{ 'selected' if not template or template.text_alignment == 'left' else '' }}>Left</option>
                    <option value="center" {{ 'selected' if template and template.text_alignment == 'center' else '' }}>Center</option>
                    <option value="right" {{ 'selected' if template and template.text_alignment == 'right' else '' }}>Right</option>
                </select>
            </div>

            <div class="form-group">
                <label for="global_scale">Global Scale</label>
                <input type="number" id="global_scale" name="global_scale" step="0.1" min="0.1"
                       value="{{ template.global_scale if template and template.global_scale else '1.0' }}">
                <div class="help-text">Overall scaling factor (1.0 = normal).</div>
            </div>

            <div class="form-group">
                <label for="manual_size_scale">Manual Size Scale</label>
                <input type="number" id="manual_size_scale" name="manual_size_scale" step="0.1" min="0"
                       value="{{ template.manual_size_scale if template and template.manual_size_scale else '' }}">
                <div class="help-text">Manual size scale override (optional).</div>
            </div>

            <div class="form-group">
                <label for="handwriting_size">Handwriting Size</label>
                <select id="handwriting_size" name="handwriting_size">
                    <option value="" {{ 'selected' if not template or not template.handwriting_size else '' }}>Default (Normal)</option>
                    <optgroup label="Common Sizes">
                        <option value="tiny" {{ 'selected' if template and template.handwriting_size == 'tiny' else '' }}>Tiny (0.5x)</option>
                        <option value="small" {{ 'selected' if template and template.handwriting_size == 'small' else '' }}>Small (0.75x)</option>
                        <option value="medium" {{ 'selected' if template and template.handwriting_size == 'medium' else '' }}>Medium (1.0x)</option>
                        <option value="large" {{ 'selected' if template and template.handwriting_size == 'large' else '' }}>Large (1.35x)</option>
                        <option value="xl" {{ 'selected' if template and template.handwriting_size == 'xl' else '' }}>Extra Large (1.7x)</option>
                        <option value="huge" {{ 'selected' if template and template.handwriting_size == 'huge' else '' }}>Huge (2.0x)</option>
                    </optgroup>
                    <optgroup label="Special Styles">
                        <option value="christmas" {{ 'selected' if template and template.handwriting_size == 'christmas' else '' }}>Christmas (1.5x)</option>
                        <option value="headline" {{ 'selected' if template and template.handwriting_size == 'headline' else '' }}>Headline (1.8x)</option>
                        <option value="formal" {{ 'selected' if template and template.handwriting_size == 'formal' else '' }}>Formal (0.9x)</option>
                        <option value="casual" {{ 'selected' if template and template.handwriting_size == 'casual' else '' }}>Casual (1.15x)</option>
                        <option value="fine" {{ 'selected' if template and template.handwriting_size == 'fine' else '' }}>Fine Print (0.65x)</option>
                        <option value="compact" {{ 'selected' if template and template.handwriting_size == 'compact' else '' }}>Compact (0.7x)</option>
                        <option value="comfortable" {{ 'selected' if template and template.handwriting_size == 'comfortable' else '' }}>Comfortable (1.2x)</option>
                        <option value="bold" {{ 'selected' if template and template.handwriting_size == 'bold' else '' }}>Bold (1.4x)</option>
                    </optgroup>
                </select>
                <div class="help-text">Preset size for handwriting. Use for quick adjustments like Christmas cards or headlines.</div>
            </div>
        </div>

        <div class="form-check">
            <input type="checkbox" id="auto_size" name="auto_size"
                   {{ 'checked' if template and template.auto_size else '' }}>
            <label for="auto_size">Enable Auto Size</label>
            <div class="help-text">Automatically adjust text size to fit the page.</div>
        </div>

        <div class="form-section-title">Styling (Optional)</div>

        <div class="form-group">
            <label for="background_color">Background Color</label>
            <input type="text" id="background_color" name="background_color"
                   value="{{ template.background_color if template else '' }}"
                   placeholder="e.g., white, #FFFFFF, transparent">
            <div class="help-text">CSS color value for page background.</div>
        </div>

        <div class="form-section-title">Style Control (Advanced)</div>

        <div class="form-group">
            <label for="biases">Biases</label>
            <input type="text" id="biases" name="biases"
                   value="{{ template.biases if template and template.biases else '' }}"
                   placeholder="e.g., 0.75|0.8|0.9">
            <div class="help-text">Pipe-separated values for style variance control.</div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="per_line_styles">Per-Line Styles</label>
                <input type="text" id="per_line_styles" name="per_line_styles"
                       value="{{ template.per_line_styles if template and template.per_line_styles else '' }}"
                       placeholder="e.g., 1,2,3,1">
                <div class="help-text">Comma-separated style indices for each line.</div>
            </div>

            <div class="form-group">
                <label for="stroke_colors">Stroke Colors</label>
                <input type="text" id="stroke_colors" name="stroke_colors"
                       value="{{ template.stroke_colors if template and template.stroke_colors else '' }}"
                       placeholder="e.g., black,blue,red">
                <div class="help-text">Comma-separated color values per line.</div>
            </div>

            <div class="form-group">
                <label for="stroke_widths">Stroke Widths</label>
                <input type="text" id="stroke_widths" name="stroke_widths"
                       value="{{ template.stroke_widths if template and template.stroke_widths else '' }}"
                       placeholder="e.g., 2,3,2">
                <div class="help-text">Comma-separated width values per line.</div>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="horizontal_stretch">Horizontal Stretch</label>
                <input type="number" id="horizontal_stretch" name="horizontal_stretch" step="0.1" min="0.1"
                       value="{{ template.horizontal_stretch if template and template.horizontal_stretch else '1.0' }}">
                <div class="help-text">Horizontal scaling (1.0 = normal).</div>
            </div>
        </div>

        <div class="form-check">
            <input type="checkbox" id="denoise" name="denoise"
                   {{ 'checked' if template and template.denoise else '' }}>
            <label for="denoise">Enable Denoise</label>
            <div class="help-text">Apply denoising to generated handwriting.</div>
        </div>

        <div class="form-section-title">Text Wrapping (Advanced)</div>

        <div class="form-row">
            <div class="form-group">
                <label for="character_width">Character Width (px)</label>
                <input type="number" id="character_width" name="character_width" step="0.1" min="0"
                       value="{{ template.character_width if template and template.character_width else '' }}">
                <div class="help-text">Estimated character width for text wrapping.</div>
            </div>

            <div class="form-group">
                <label for="wrap_ratio">Wrap Ratio</label>
                <input type="number" id="wrap_ratio" name="wrap_ratio" step="0.01" min="0"
                       value="{{ template.wrap_ratio if template and template.wrap_ratio else '' }}">
                <div class="help-text">Text wrapping ratio.</div>
            </div>

            <div class="form-group">
                <label for="wrap_utilization">Wrap Utilization</label>
                <input type="number" id="wrap_utilization" name="wrap_utilization" step="0.01" min="0"
                       value="{{ template.wrap_utilization if template and template.wrap_utilization else '' }}">
                <div class="help-text">Wrap utilization factor.</div>
            </div>
        </div>

        <div class="form-section-title">Chunked Generation (Advanced)</div>

        <div class="form-check">
            <input type="checkbox" id="use_chunked_generation" name="use_chunked_generation"
                   {{ 'checked' if template and template.use_chunked_generation else '' }}>
            <label for="use_chunked_generation">Enable Chunked Generation</label>
            <div class="help-text">Generate text in smaller chunks for better performance.</div>
        </div>

        <div class="form-check">
            <input type="checkbox" id="adaptive_chunking" name="adaptive_chunking"
                   {{ 'checked' if template and template.adaptive_chunking else '' }}>
            <label for="adaptive_chunking">Enable Adaptive Chunking</label>
            <div class="help-text">Use adaptive chunking based on text structure.</div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="adaptive_strategy">Adaptive Strategy</label>
                <select id="adaptive_strategy" name="adaptive_strategy">
                    <option value="">-- Select a strategy --</option>
                    <option value="balanced" {{ 'selected' if template and template.adaptive_strategy == 'balanced' else '' }}>Balanced</option>
                    <option value="word_length" {{ 'selected' if template and template.adaptive_strategy == 'word_length' else '' }}>Word Length</option>
                    <option value="sentence" {{ 'selected' if template and template.adaptive_strategy == 'sentence' else '' }}>Sentence</option>
                    <option value="punctuation" {{ 'selected' if template and template.adaptive_strategy == 'punctuation' else '' }}>Punctuation</option>
                    <option value="fixed" {{ 'selected' if template and template.adaptive_strategy == 'fixed' else '' }}>Fixed</option>
                </select>
                <div class="help-text">Strategy for adaptive chunking.</div>
            </div>

            <div class="form-group">
                <label for="words_per_chunk">Words Per Chunk</label>
                <input type="number" id="words_per_chunk" name="words_per_chunk" step="1" min="1"
                       value="{{ template.words_per_chunk if template and template.words_per_chunk else '' }}">
                <div class="help-text">Number of words per chunk.</div>
            </div>

            <div class="form-group">
                <label for="chunk_spacing">Chunk Spacing</label>
                <input type="number" id="chunk_spacing" name="chunk_spacing" step="0.1" min="0"
                       value="{{ template.chunk_spacing if template and template.chunk_spacing else '' }}">
                <div class="help-text">Spacing between text chunks.</div>
            </div>

            <div class="form-group">
                <label for="max_line_width">Max Line Width</label>
                <input type="number" id="max_line_width" name="max_line_width" step="0.1" min="0"
                       value="{{ template.max_line_width if template and template.max_line_width else '' }}">
                <div class="help-text">Maximum width for each line.</div>
            </div>
        </div>

        <div class="form-check">
            <input type="checkbox" id="is_active" name="is_active"
                   {{ 'checked' if not template or template.is_active else '' }}>
            <label for="is_active">Template is active</label>
            <div class="help-text">Inactive templates will not appear in selection lists.</div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">
                {{ 'Update Template' if action == 'edit' else 'Create Template' }}
            </button>
            <a href="{{ url_for('admin.templates') }}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>
{% endblock %}
