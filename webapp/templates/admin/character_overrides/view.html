{% extends "admin/base.html" %}

{% set active_nav = 'character_overrides' %}

{% block title %}{{ collection.name }} - Character Overrides - Admin - WriteBot{% endblock %}

{% block admin_extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/character_overrides.css') }}" />
{% endblock %}

{% block admin_title %}{{ collection.name }}{% endblock %}

{% block admin_header_actions %}
<a href="{{ url_for('character_overrides.edit_collection', collection_id=collection.id) }}" class="btn btn-secondary">Edit Collection</a>
<a href="{{ url_for('character_overrides.list_collections') }}" class="btn btn-ghost">Back to Collections</a>
{% endblock %}

{% block admin_content %}
{# Collection Information #}
<div class="collection-info">
    <h2>Collection Information</h2>
    <p>{{ collection.description or 'No description provided.' }}</p>
    <div class="collection-stats">
        <div class="collection-stat">
            <strong>{{ grouped_overrides|length }}</strong>
            <span>Unique Characters</span>
        </div>
        <div class="collection-stat">
            <strong>{{ collection.get_character_count() }}</strong>
            <span>Total Variants</span>
        </div>
        <div class="collection-stat">
            {% if collection.is_active %}
            <span class="badge badge-active">Active</span>
            {% else %}
            <span class="badge badge-inactive">Inactive</span>
            {% endif %}
        </div>
    </div>
</div>

{# Upload Section #}
<div class="upload-section">
    <h3>Upload Character Variants</h3>

    <div class="info-box">
        <strong>Pen Plotter Compatibility:</strong>
        <ul style="margin: 8px 0; padding-left: 20px;">
            <li><strong>Recommended:</strong> Use the Draw Character tab for guaranteed compatibility</li>
            <li>For uploaded SVGs: Use stroke-based paths, NOT filled paths</li>
            <li>Set <code>stroke="black"</code>, <code>stroke-width="1-3"</code>, and <code>fill="none"</code></li>
            <li>Must include viewBox or width/height attributes</li>
            <li>Recommended size: approximately 100-200px height for best results</li>
        </ul>
        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e0e0e0;">
            <strong>Keyboard Shortcuts:</strong> Press <kbd>1</kbd> for Draw Character, <kbd>2</kbd> for Single Upload, <kbd>3</kbd> for Batch Upload
        </div>
    </div>

    <div class="upload-tabs">
        <button class="upload-tab active" data-tab="draw">Draw Character</button>
        <button class="upload-tab" data-tab="single">Single Upload</button>
        <button class="upload-tab" data-tab="batch">Batch Upload</button>
    </div>

    {# Draw Character Interface #}
    <div id="draw-upload" class="upload-content active">
        <div class="draw-interface">
            <div class="draw-controls">
                <div class="form-group" style="max-width: 120px;">
                    <label for="draw-character">Character *</label>
                    <input type="text" id="draw-character" maxlength="1" required autocomplete="off" placeholder="a">
                </div>
                <div class="form-group" style="max-width: 160px;">
                    <label for="draw-baseline-offset">Baseline Offset</label>
                    <input type="number" id="draw-baseline-offset" value="0" step="0.1">
                </div>
                <div class="form-group" style="max-width: 140px;">
                    <label for="draw-stroke-width">Stroke Width</label>
                    <input type="number" id="draw-stroke-width" value="1" min="1" max="10" step="0.5">
                </div>
                <div class="button-group" style="margin-top: 24px;">
                    <button type="button" id="clear-canvas" class="btn btn-secondary">Clear</button>
                    <button type="button" id="undo-stroke" class="btn btn-secondary">Undo</button>
                    <button type="button" id="save-drawing" class="btn btn-primary">Save Character</button>
                </div>
            </div>
            <div class="draw-canvas-container">
                <div class="canvas-label">Draw your character below:</div>
                <div id="draw-area"></div>
                <div class="canvas-help">
                    Use your mouse or touchscreen to draw. The character will be saved as a pen-plotter-compatible stroke-based SVG.
                </div>
            </div>
        </div>
    </div>

    {# Single Upload Form #}
    <div id="single-upload" class="upload-content">
        <form method="POST" action="{{ url_for('character_overrides.upload_character', collection_id=collection.id) }}" enctype="multipart/form-data">
            <div class="form-inline">
                <div class="form-group" style="max-width: 120px;">
                    <label for="character">Character *</label>
                    <input type="text" id="character" name="character" maxlength="1" required autocomplete="off">
                    <div class="help-text">Single character</div>
                </div>
                <div class="form-group" style="max-width: 160px;">
                    <label for="baseline_offset">Baseline Offset</label>
                    <input type="number" id="baseline_offset" name="baseline_offset" value="0" step="0.1">
                    <div class="help-text">Vertical adjustment</div>
                </div>
                <div class="form-group" style="flex: 2;">
                    <label for="svg_file">SVG File *</label>
                    <input type="file" id="svg_file" name="svg_file" accept=".svg" required>
                </div>
                <button type="submit" class="btn btn-primary">Upload</button>
            </div>
        </form>
    </div>

    {# Batch Upload Form #}
    <div id="batch-upload" class="upload-content">
        <form method="POST" action="{{ url_for('character_overrides.upload_batch', collection_id=collection.id) }}" enctype="multipart/form-data">
            <div class="form-inline">
                <div class="form-group" style="max-width: 160px;">
                    <label for="batch_baseline_offset">Baseline Offset</label>
                    <input type="number" id="batch_baseline_offset" name="baseline_offset" value="0" step="0.1">
                    <div class="help-text">Applied to all files</div>
                </div>
                <div class="form-group" style="flex: 2;">
                    <label for="svg_files">SVG Files *</label>
                    <input type="file" id="svg_files" name="svg_files" accept=".svg" multiple required>
                    <div class="help-text">Character extracted from filename (e.g., 'a.svg', 'a_1.svg', 'a_2.svg')</div>
                </div>
                <button type="submit" class="btn btn-primary">Upload All</button>
            </div>
        </form>
    </div>
</div>

{# Character Variants Display #}
<div class="characters-section">
    <h3>Character Variants</h3>

    {% if grouped_overrides %}
        {% for character, variants in grouped_overrides.items()|sort %}
        <div class="character-group">
            <div class="character-group-header">
                <div style="display: flex; align-items: center;">
                    <span class="character-badge">{{ character }}</span>
                    <div>
                        <span class="character-group-title">
                            Character: "{{ character }}"
                        </span>
                        <span class="variant-count">({{ variants|length }} variant{{ 's' if variants|length > 1 else '' }})</span>
                    </div>
                </div>
            </div>

            <div class="variants-grid">
                {% for variant in variants %}
                <div class="variant-card">
                    <div class="variant-preview" title="Click to zoom">
                        <img src="{{ url_for('character_overrides.preview_character', override_id=variant.id) }}"
                             alt="Variant for '{{ character }}'"
                             loading="lazy">
                    </div>
                    <div class="variant-info">
                        <strong>ViewBox:</strong> {{ "%.0f" | format(variant.viewbox_width) }} Ã— {{ "%.0f" | format(variant.viewbox_height) }}<br>
                        <strong>Offset:</strong> {{ variant.baseline_offset }}
                    </div>
                    <form method="POST"
                          action="{{ url_for('character_overrides.delete_character', override_id=variant.id) }}"
                          style="display: inline;">
                        <button type="submit" class="btn btn-danger">Delete</button>
                    </form>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="empty-state">
            <p class="empty-state__message">No character variants uploaded yet.</p>
            <p style="color: #8d8d8d; font-size: 14px; margin-top: 8px;">
                Use the upload form above to add characters to this collection.
            </p>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block admin_extra_js %}
<style>
    kbd {
        display: inline-block;
        padding: 2px 6px;
        font-family: monospace;
        font-size: 11px;
        background-color: #f4f4f4;
        border: 1px solid #c6c6c6;
        border-radius: 3px;
        box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2);
    }

    .draw-interface {
        display: flex;
        gap: 24px;
        margin-top: 16px;
    }

    .draw-controls {
        display: flex;
        flex-direction: column;
        gap: 12px;
        flex: 0 0 auto;
    }

    .draw-canvas-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .canvas-label {
        font-weight: 600;
        margin-bottom: 8px;
        color: #161616;
    }

    #draw-area {
        width: 200px;
        height: 300px;
        border: 2px solid #8d8d8d;
        border-radius: 4px;
        background: white;
        position: relative;
    }

    #draw-area svg {
        cursor: crosshair;
        border-radius: 4px;
    }

    .canvas-help {
        margin-top: 8px;
        font-size: 13px;
        color: #8d8d8d;
        max-width: 400px;
        text-align: center;
    }

    .button-group {
        display: flex;
        gap: 8px;
    }
</style>

<!-- Load character drawer module -->
<script src="{{ url_for('static', filename='js/character_overrides.js') }}"></script>
<script src="{{ url_for('static', filename='js/character_drawer.js') }}"></script>

<script>
    // Initialize character drawer when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        const collectionId = {{ collection.id }};
        CharacterDrawer.init(collectionId);
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ignore if typing in input field
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

        if (e.key === '1') {
            const tab = document.querySelector('[data-tab="draw"]');
            if (tab) tab.click();
        } else if (e.key === '2') {
            const tab = document.querySelector('[data-tab="single"]');
            if (tab) tab.click();
        } else if (e.key === '3') {
            const tab = document.querySelector('[data-tab="batch"]');
            if (tab) tab.click();
        }
    });
</script>

{% endblock %}