name: Backup Database

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual backup

jobs:
  backup:
    name: Backup Production Database
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Create backup on server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          ssh $SERVER_USER@$SERVER_HOST << 'ENDSSH'
            set -e

            BACKUP_DIR="/opt/writebot-backups"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)

            echo "Creating backup at $BACKUP_DIR/writebot_${TIMESTAMP}.db"

            # Create backup directory if it doesn't exist
            mkdir -p $BACKUP_DIR

            # Backup database
            docker exec writebot-app cp /app/webapp/instance/writebot.db /tmp/writebot_backup.db
            docker cp writebot-app:/tmp/writebot_backup.db $BACKUP_DIR/writebot_${TIMESTAMP}.db

            # Compress backup
            gzip $BACKUP_DIR/writebot_${TIMESTAMP}.db

            # Keep only last 30 days of backups
            find $BACKUP_DIR -name "writebot_*.db.gz" -mtime +30 -delete

            echo "Backup completed successfully!"
            ls -lh $BACKUP_DIR | tail -5
          ENDSSH

      - name: Download backup (optional)
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          mkdir -p backups
          scp $SERVER_USER@$SERVER_HOST:/opt/writebot-backups/writebot_${TIMESTAMP}.db.gz backups/ || echo "Backup file not found for download"
        continue-on-error: true

      - name: Upload backup artifact
        uses: actions/upload-artifact@v4
        with:
          name: database-backup
          path: backups/
          retention-days: 30
        continue-on-error: true
