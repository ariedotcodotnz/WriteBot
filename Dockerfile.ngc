# NGC TensorFlow Dockerfile for WriteBot
# Uses NVIDIA NGC TensorFlow container with latest GPU support (including Blackwell)
#
# NGC containers include TensorFlow with optimized CUDA/cuDNN for latest GPUs
# https://catalog.ngc.nvidia.com/orgs/nvidia/containers/tensorflow
#
# Usage:
#   docker compose -f docker-compose.production.yml build
#   (after updating dockerfile: Dockerfile.ngc in docker-compose.production.yml)

#=============================================================================
# BUILD ARGUMENTS
#=============================================================================
ARG NGC_VERSION=25.01
ARG GUNICORN_WORKERS=2
ARG GUNICORN_THREADS=4
ARG GUNICORN_TIMEOUT=180

# NGC TensorFlow container - includes TF + CUDA + cuDNN with latest GPU support
FROM nvcr.io/nvidia/tensorflow:${NGC_VERSION}-tf2-py3

# Re-declare ARGs after FROM
ARG GUNICORN_WORKERS=2
ARG GUNICORN_THREADS=4
ARG GUNICORN_TIMEOUT=180

# Prevent timezone prompt
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC

# Set working directory
WORKDIR /app

# Install additional system dependencies
RUN apt-get update && apt-get install -y \
    libhdf5-dev \
    pkg-config \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements and install Python dependencies
# IMPORTANT: Do NOT reinstall TensorFlow - NGC already has it configured correctly
# Only install non-TF dependencies to avoid breaking NGC's CUDA stack
COPY requirements-ngc.txt .
RUN pip install --no-cache-dir -r requirements-ngc.txt

# Install tf-keras and tensorflow-probability compatible with NGC's TF 2.17
# TFP 0.24.x is compatible with TF 2.17, TFP 0.25+ requires TF 2.18+
# Use --no-deps to avoid pulling in a different TensorFlow version
RUN pip install --no-cache-dir --no-deps "tf-keras>=2.17.0,<2.18.0" "tensorflow-probability>=0.24.0,<0.25.0"

# Copy application code
COPY . .

# Create necessary directories
RUN mkdir -p webapp/instance webapp/logs webapp/job_storage model/data

# Set environment variables from build args
ENV GUNICORN_WORKERS=${GUNICORN_WORKERS}
ENV GUNICORN_THREADS=${GUNICORN_THREADS}
ENV GUNICORN_TIMEOUT=${GUNICORN_TIMEOUT}

# Set environment variables
# NOTE: Blackwell (RTX 5070) not yet supported - forcing CPU mode
ENV FLASK_ENV=production
ENV PYTHONUNBUFFERED=1
ENV TF_CPP_MIN_LOG_LEVEL=2
ENV CUDA_VISIBLE_DEVICES=""
ENV TF_XLA_FLAGS=""
ENV TF_USE_LEGACY_KERAS=1

# Expose port
EXPOSE 5000

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD python -c "import requests; requests.get('http://localhost:5000/api/health', timeout=5)" || exit 1

# Run database initialization and start the application
CMD ["bash", "-c", "python webapp/init_db.py --auto && gunicorn --bind 0.0.0.0:5000 --workers ${GUNICORN_WORKERS} --threads ${GUNICORN_THREADS} --timeout ${GUNICORN_TIMEOUT} --access-logfile - --error-logfile - webapp.app:app"]
